<!DOCTYPE html>
  <html>
  <head>
    <meta charset=utf-8 />
    <title>Esri Leaflet Debugging Sample</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <!-- Load Leaflet from CDN-->
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>

    <!-- Load Esri Leaflet from source-->
    <script src="../src/EsriLeaflet.js"></script>
    <script src="../src/Request.js"></script>
    <script src="../src/Util.js"></script>
    <script src="../src/Controls/Logo.js"></script>

    <script src="../src/Services/Service.js"></script>
    <script src="../src/Services/FeatureLayer.js"></script>
    <script src="../src/Services/ImageService.js"></script>
    <script src="../src/Services/MapService.js"></script>

    <script src="../src/Layers/FeatureLayer/FeatureGrid.js"></script>
    <script src="../src/Layers/FeatureLayer/FeatureManager.js"></script>
    <script src="../src/Layers/FeatureLayer/FeatureLayer.js"></script>

    <script src="../src/Layers/RasterLayer.js"></script>
    <script src="../src/Layers/ImageMapLayer.js"></script>
    <script src="../src/Layers/TiledMapLayer.js"></script>
    <script src="../src/Layers/BasemapLayer.js"></script>
    <script src="../src/Layers/DynamicMapLayer.js"></script>

    <script src="../src/Tasks/Task.js"></script>
    <script src="../src/Tasks/Find.js"></script>
    <script src="../src/Tasks/Identify.js"></script>
    <script src="../src/Tasks/IdentifyFeatures.js"></script>
    <script src="../src/Tasks/IdentifyImage.js"></script>
    <script src="../src/Tasks/Query.js"></script>

    <style>
      body {
        margin:0;
        padding:0;
      }

      #map {
        position: absolute;
        top:0;
        bottom:0;
        right:0;left:0;
      }

      #info-pane {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        padding: 1em;
        background: white;
      }
    </style>
  </head>
  <body>

  <div id="map"></div>
  <div id="info-pane" class="leaflet-bar">
    <label>
    sample application for debugging
    </label>
  </div>

  <script>
    /*
    make a copy of this file in the same folder if you'd like git to ignore your local changes
    */

    var map = L.map('map').setView([40, -100], 4);
    L.esri.basemapLayer('Topographic').addTo(map);

    var url = 'http://sampleserver3.arcgisonline.com/ArcGIS/rest/services/SanFrancisco/311Incidents/FeatureServer/0/';

    var fl = L.esri.featureLayer(url, {
      where: 'objectid=13116467',
      useCors: false
    }).addTo(map);

    // this works
    attachUrl = url + '13116467' + '/attachments/';
      L.esri.Request.get.JSONP(attachUrl, {f:'json'}, function(error, response){
        outputUrl = attachUrl + response.attachmentInfos[0].id;
        document.getElementById('info-pane').innerHTML = '<img src="' + outputUrl + '"/>'
    });

    // but i can't figure out how to jam an async request into bindPopups callback
    fl.bindPopup(function(features){
      attachUrl = url + features.id + '/attachments/';
      L.esri.Request.get.JSONP(attachUrl, {f:'json'}, function(error, response){
        var outputUrl = attachUrl + response.attachmentInfos[0].id;
        features.properties.attachmentUrl = outputUrl;
        //return '<img src="' + outputUrl + '"/>'
      });
      return '<img src="' + features.properties.attachmentUrl + '"/>'
    });
  </script>

  </body>
  </html>